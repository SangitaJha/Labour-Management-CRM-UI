<!DOCTYPE html>
<html>
<head>
  <title>User Profile</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="js/auth.js"></script>
  <style>
    .profile-container {
      max-width: 800px;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .profile-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 30px;
      color: white;
      text-align: center;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 50px;
      border: 3px solid white;
    }

    .profile-header h2 {
      margin: 15px 0 5px;
      font-size: 28px;
    }

    .profile-header p {
      opacity: 0.9;
      margin: 0;
    }

    .profile-body {
      padding: 40px;
    }

    .profile-section {
      margin-bottom: 30px;
    }

    .profile-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .profile-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }

    .info-field {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .info-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 16px;
      color: #2c3e50;
      font-weight: 600;
    }

    .edit-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      display: none;
    }

    .edit-form.show {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
      font-size: 13px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-edit {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      margin-top: 15px;
      width: auto;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .back-button:hover {
      gap: 15px;
    }
  </style>
</head>
<body>
  <!-- Left Sidebar -->
  <div class="sidebar">
    <h2 class="sidebar-brand">Labour CRM</h2>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="sidebar-item">
        <i class="fas fa-home"></i>
        <span>Dashboard</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
      <a href="attendance.html" class="sidebar-item">
        <i class="fas fa-clipboard-check"></i>
        <span>Attendance</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
      <a href="workers.html" class="sidebar-item">
        <i class="fas fa-users"></i>
        <span>Workers</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
      <a href="contractors.html" class="sidebar-item">
        <i class="fas fa-hard-hat"></i>
        <span>Contractors</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
      <a href="payments.html" class="sidebar-item">
        <i class="fas fa-money-bill-wave"></i>
        <span>Payments</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
      <a href="reports.html" class="sidebar-item">
        <i class="fas fa-chart-bar"></i>
        <span>Reports</span>
        <i class="fas fa-chevron-right arrow"></i>
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Top Header Bar -->
    <div class="header">
      <div class="header-left">
        <h1>User Profile</h1>
      </div>
      <div class="header-right">
        <div class="breadcrumb">
          <span>Account</span> / <span>Profile</span>
        </div>
        <div class="user-profile-menu">
          <div class="user-info">
            <span id="userNameDisplay">Guest</span>
            <span id="userRoleDisplay" class="user-role-badge"></span>
          </div>
          <button class="user-menu-btn" onclick="toggleUserMenu()">
            <i class="fas fa-user-circle"></i>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div id="userDropdown" class="user-dropdown">
            <a href="#" onclick="goToProfile()"><i class="fas fa-user"></i> Profile</a>
            <a href="#" onclick="goToSettings()"><i class="fas fa-cog"></i> Settings</a>
            <hr>
            <a href="#" onclick="logout()" style="color: #d32f2f;"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Container -->
    <div class="profile-container">
      <div class="profile-header">
        <div class="profile-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <h2 id="profileName">User Name</h2>
        <p id="profileRole">Role</p>
      </div>

      <div class="profile-body">
        <a class="back-button" onclick="window.history.back()">
          <i class="fas fa-arrow-left"></i>
          Go Back
        </a>

        <div id="alertBox" class="alert"></div>

        <!-- Profile Information Section -->
        <div class="profile-section">
          <h3>Personal Information</h3>
          <div class="profile-info">
            <div class="info-field">
              <div class="info-label">Full Name</div>
              <div class="info-value" id="displayName">-</div>
            </div>
            <div class="info-field">
              <div class="info-label">Email Address</div>
              <div class="info-value" id="displayEmail">-</div>
            </div>
            <div class="info-field">
              <div class="info-label">Phone Number</div>
              <div class="info-value" id="displayPhone">-</div>
            </div>
            <div class="info-field">
              <div class="info-label">Role</div>
              <div class="info-value" id="displayRole">-</div>
            </div>
          </div>

          <button class="btn btn-edit" onclick="toggleEditForm()">
            <i class="fas fa-edit"></i> Edit Profile
          </button>

          <div class="edit-form" id="editForm">
            <form onsubmit="updateProfile(event)">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editName" required>
              </div>
              <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" id="editPhone" required>
              </div>
              <div class="form-group">
                <label>Address</label>
                <input type="text" id="editAddress" placeholder="Enter your address">
              </div>
              <div class="action-buttons">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="toggleEditForm()">Cancel</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Account Information Section -->
        <div class="profile-section">
          <h3>Account Information</h3>
          <div class="profile-info">
            <div class="info-field">
              <div class="info-label">Account Status</div>
              <div class="info-value">
                <span style="color: #28a745;">âœ“ Active</span>
              </div>
            </div>
            <div class="info-field">
              <div class="info-label">Member Since</div>
              <div class="info-value" id="joinDate">-</div>
            </div>
            <div class="info-field">
              <div class="info-label">Last Login</div>
              <div class="info-value" id="lastLogin">-</div>
            </div>
            <div class="info-field">
              <div class="info-label">Verification Status</div>
              <div class="info-value">
                <span style="color: #28a745;">âœ“ Verified</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Security Section -->
        <div class="profile-section">
          <h3>Security</h3>
          <button class="btn btn-primary" style="width: 100%;" onclick="goToSettings()">
            <i class="fas fa-lock"></i> Change Password
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';

    async function loadProfile() {
      const user = getCurrentUser();
      if (!user) return;

      try {
        const response = await apiRequest('/auth/me');
        if (response && response.user) {
          const userData = response.user;

          // Update header
          document.getElementById('profileName').textContent = userData.name || 'User';
          document.getElementById('profileRole').textContent = {
            'admin': 'ðŸ‘¨â€ðŸ’¼ Administrator',
            'manager': 'ðŸ‘· Manager',
            'supervisor': 'âš™ï¸ Supervisor',
            'accounts': 'ðŸ’° Accounts Officer'
          }[userData.role] || userData.role;

          // Update display
          document.getElementById('displayName').textContent = userData.name || '-';
          document.getElementById('displayEmail').textContent = userData.email || '-';
          document.getElementById('displayPhone').textContent = userData.phone || '-';
          document.getElementById('displayRole').textContent = userData.role || '-';
          document.getElementById('joinDate').textContent = new Date(userData.created_at).toLocaleDateString();
          document.getElementById('lastLogin').textContent = userData.last_login ? new Date(userData.last_login).toLocaleString() : 'Never';

          // Update form
          document.getElementById('editName').value = userData.name || '';
          document.getElementById('editPhone').value = userData.phone || '';
          document.getElementById('editAddress').value = userData.address || '';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    function toggleEditForm() {
      const form = document.getElementById('editForm');
      form.classList.toggle('show');
    }

    async function updateProfile(event) {
      event.preventDefault();

      const name = document.getElementById('editName').value;
      const phone = document.getElementById('editPhone').value;
      const address = document.getElementById('editAddress').value;

      try {
        const response = await apiRequest('/auth/profile', {
          method: 'PUT',
          body: JSON.stringify({ name, phone, address })
        });

        if (response.success) {
          // Update localStorage
          const user = getCurrentUser();
          user.name = name;
          localStorage.setItem('user', JSON.stringify(user));

          showAlert('Profile updated successfully!', 'success');
          toggleEditForm();
          loadProfile();
        } else {
          showAlert(response.error || 'Failed to update profile', 'error');
        }
      } catch (error) {
        showAlert('Error updating profile', 'error');
      }
    }

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert show ${type}`;
      setTimeout(() => {
        alertBox.className = 'alert';
      }, 5000);
    }

    // Load profile on page load
    window.addEventListener('load', loadProfile);
  </script>
</body>
</html>
